WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.drag-and-drop:filestore-uploader', location = 'js/filestore-uploader.js' */
define("confluence-drag-and-drop/filestore-uploader","jquery underscore confluence-drag-and-drop/drag-and-drop-utils confluence/meta confluence/api/constants confluence/get-content-id".split(" "),function(g,k,v,l,m,w){function q(){var b={},a=l.get("page-id");"0"===a?b.draftId=l.get("draft-id"):b.pageId=a;if(a=l.get("drag-and-drop-entity-id"))b.dragAndDropEntityId=a;return b}function n(b){return{generalError:{message:"Error connecting to server",fileIds:b}}}function p(b,a){try{var c=JSON.parse(b.responseText);
if(c.fileErrors&&c.fileErrors.length)return r(c);if(c.error)return{generalError:{message:c.error,fileIds:a}}}catch(d){return n(a)}}function r(b){var a=[];b.fileErrors&&b.fileErrors.length&&k.each(b.fileErrors,function(b){a.push({id:b.clientFileId,message:b.errorMessage})});return{fileErrors:a}}function f(){}function x(b,a,c,d){g.ajax({url:m.CONTEXT_PATH+"/rest/internal/1.0/media/uploadTokenData?contentId\x3d"+b}).done(function(c){a.uploadToken=c.token;a.clientId=c.config.clientId;a.fileStoreUrl=c.config.fileStoreUrl;
a.collection=c.collectionNames[b];a.hasCollection=!0;d.resolve()}).fail(function(a){d.resolve(p(a,k.map(c,function(a){return a.id})))});return d}function t(b,a,c,d){g.ajax({type:"POST",url:m.CONTEXT_PATH+"/rest/drag-and-drop/1/filestore/upload/validate",data:JSON.stringify(b),contentType:"application/json"}).done(function(b){a.uploadToken=b.token;a.clientId=b.clientId;a.fileStoreUrl=b.fileStoreUrl;a.collection=b.collectionName;a.hasCollection=!0;d.resolve(r(b))}).fail(function(a){d.resolve(p(a,k.map(c,
function(a){return a.id})))});return d}f.prototype.filesAdded=function(b,a,c){var d=g.Deferred();if(!a)return d.resolve({}).promise();var e=[];for(b=0;b<a.length;b++){var f=a[b];f.status!==plupload.FAILED&&e.push(f)}if(0===e.length)return d.resolve({}).promise();var h=q();h.files=k.map(e,function(a){return{name:a.name,clientFileId:a.id,size:a.size}});var u=w();a=g.ajax({url:m.CONTEXT_PATH+"/rest/api/content/"+u+"/property/editor"});a.done(function(a){"v2"===a.value?x(u,c,e,d):t(h,c,e,d)});a.fail(function(a){404===
a.status?t(h,c,e,d):d.resolve(n())});return d.promise()};f.prototype.beforeUpload=function(b,a,c){a=c.fileStoreUrl+"/file/binary";var d={token:c.uploadToken,client:c.clientId};c.hasCollection&&(d.collection=c.collection);b.settings.url=plupload.buildUrl(a,d)};f.prototype.fileUploaded=function(b,a,c,d){var e=g.Deferred();if(c.response){b=JSON.parse(c.response).data;c=a.name.substr(a.name.lastIndexOf(".")+1);var f=b.id,h=q();k.extend(h,{fileStoreId:f,fileName:b.name,mimeType:plupload.mimeTypes[c.toLowerCase()]||
v.defaultMimeType,size:b.size,minorEdit:!0,renderEditorHTML:!!d,contentType:l.get("content-type"),uploadSource:"legacy-dnd"});g.ajax({type:"POST",url:m.CONTEXT_PATH+"/rest/drag-and-drop/1/filestore/upload",data:JSON.stringify(h),contentType:"application/json"}).done(function(b){e.resolve({fileId:a.id,fileServerId:b.id,htmlForEditor:b.htmlForEditor})}).fail(function(b){b=p(b,[a.id]);e.reject(b)})}else e.reject(n([a.id]));return e.promise()};f.prototype.serverError=function(b){var a;try{var c=JSON.parse(b).error;
c&&(a=c.code)}catch(d){console.debug("Failed to parse server error response")}return a};return f});
}catch(e){WRMCB(e)};