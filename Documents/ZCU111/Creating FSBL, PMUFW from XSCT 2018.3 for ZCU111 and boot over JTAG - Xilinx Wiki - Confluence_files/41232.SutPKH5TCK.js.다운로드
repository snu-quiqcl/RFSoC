"use strict";(self._cf=self._cf||[]).push([[41232],{441232:(e,t,o)=>{o.d(t,{Fs:()=>T,LX:()=>c,bk:()=>ce,zS:()=>le,fH:()=>de,d8:()=>he});var n=o(991332),r=o(435715),a=o(313156);const i=new a.PluginKey("referentialityPlugin"),s=e=>e&&i.getState(e);var d=o(29298);class c{constructor(){(0,d.Z)(this,"subscriptions",new Map),(0,d.Z)(this,"dataSources",new Map)}createOrUpdate(e,t){this.dataSources.set(e,t);const o=window.requestIdleCallback||window.requestAnimationFrame,n=window.cancelIdleCallback||window.cancelAnimationFrame,r=o((()=>{n(r),this.notifySubscribers(e,t)}))}notifySubscribers(e,t){var o;this.subscriptions.has(e)&&(null===(o=this.subscriptions.get(e))||void 0===o||o.forEach((e=>{e(t)})))}subscribe(e,t){var o;this.subscriptions.has(e)||this.subscriptions.set(e,new Set),null===(o=this.subscriptions.get(e))||void 0===o||o.add(t)}unsubscribe(e,t){var o;this.subscriptions.has(e)&&(null===(o=this.subscriptions.get(e))||void 0===o||o.delete(t))}delete(e){this.dataSources.delete(e),this.notifySubscribers(e,null)}get(e){return this.dataSources.get(e)||null}clear(){this.dataSources.clear(),this.subscriptions.clear()}}class l{constructor(e){this.dataSourceProvider=e}emit(e,t){this.dataSourceProvider.createOrUpdate(e,t)}}const u="TABLE_DELETED";var h=o(387740),m=o(122551),p=o(553462),v=o(521752),N=o(953307),y=o(416450);const I=e=>{var t,o,n,r;const{editorView:a,node:i,dataSourceProvider:s}=e,d=null===(t=i.marks)||void 0===t||null===(o=t.find((e=>{var t;return e.type===(null===(t=a.state.schema.marks)||void 0===t?void 0:t.dataConsumer)})))||void 0===o||null===(n=o.attrs)||void 0===n||null===(r=n.sources)||void 0===r?void 0:r[0],[c,l]=m.useState((()=>{const e=null==s?void 0:s.get(d);if(e)return e}));return m.useEffect((()=>(null==s||s.unsubscribe(d,l),null==s||s.subscribe(d,l),()=>null==s?void 0:s.unsubscribe(d,l))),[s,d]),m.createElement(y.Z,(0,N.Z)({},e,{references:c?[c]:[]}))};class w extends p.b{render(e,t){return m.createElement(v.Z,{nodeType:this.node.type.name},m.createElement(I,{editorAppearance:e.appearance,editorView:this.view,node:this.node,getPos:this.getPos,providerFactory:e.providerFactory,handleContentDOMRef:t,extensionHandlers:e.extensionHandlers,dataSourceProvider:e.dataSourceProvider}))}}let T,A;w.displayName="ExtensionNodeWithDataSource",function(e){e.TABLE="table-adf"}(T||(T={})),function(e){e.INITIALISE_FRAGMENT_MARKS="initialiseFragmentMarks",e.CONNECT_NODES="connectNodes",e.UPDATE_SOURCE="updateSource",e.DISCONNECT_SOURCE="disconnectSource",e.UPDATE_TARGET="updateTarget",e.DISCONNECT_TARGET="disconnectTarget",e.UPDATE_FRAGMENT_MARK_NAME="updateFragmentMarkName",e.GET_CONNECTIONS="getConnections"}(A||(A={}));var E=o(115861),S=o(672815),f=o(808402),g=o(239347),C=o(923487);class b extends Error{constructor(e){super(`Unable to attach, Incorrect configuration: ${e}`),this.reason=e}}class O extends Error{constructor(e){super(`Unable to execute ${e}, API hasn't been initialized`),this.handlerName=e}}Error;Error;class k extends Error{constructor(e){super(`Unsupported type (${e})`)}}class M extends ReferenceError{constructor(e){super(`Node (${e}) could not be found`),this.localId=e}}class P extends M{constructor(e){super(e),this.localId=e}}class z extends M{constructor(e){super(e),this.localId=e}}class _ extends ReferenceError{constructor(e,t){super(`Connecting Target (${e}) to Source (${t}) will result in a Circular Reference`),this.targetLocalId=e,this.sourceLocalId=t}}class D extends ReferenceError{constructor(e){super(`LocalId (${e}) Collision has occured`),this.localId=e}}const U=e=>{const{table:t,extension:o,bodiedExtension:n,inlineExtension:r}=e.nodes;return new Map([[t,"Table"],[o,"Extension"],[n,"Extension"],[r,"Extension"]])},R=(e,t,o)=>({linkNode:{localId:t,name:null!=o?o:t,node:{type:e.type.name,attrs:(0,n.Z)({},e.attrs)}},sources:[],targets:[]}),V=({type:e,attrs:t},o,n,r)=>{var a;const i=U(o);let s="";var d;((e=>{const{extension:t,bodiedExtension:o,inlineExtension:n}=e.nodes;return new Set([t,o,n].filter(Boolean))})(o).has(e)&&r&&(s=r({node:{type:e.name,attrs:t}})),s)||(s=null!==(d=i.get(e))&&void 0!==d?d:"Element");const c=(null!==(a=null==n?void 0:n[s])&&void 0!==a?a:0)+1;return{markNameWithNumber:`${s} ${c}`,markName:s,markNameNumber:c}},L=({normalizedId:e,name:t,node:o})=>F(e,t,o),F=(e,t,o)=>{const n=(new S.JSONTransformer).encodeNode(o);return{localId:e,name:t,node:{type:n.type,attrs:n.attrs}}},x=(e,t,o)=>{var n;return t.normalizedId===o.normalizedId||!(null===(n=o.dataConsumer)||void 0===n||!n.attrs.sources.some((o=>{const n=e.getById(o);return!!n&&x(e,t,n)})))},Z=(e,t)=>{const{doc:o,schema:n}=t,r=n.marks.fragment,a=U(n);let i=null;return o.descendants(((t,o)=>{var n;if(i)return!1;if(!a.has(t.type))return!0;const s=null!==(n=r.isInSet(t.marks))&&void 0!==n?n:null;return s&&s.attrs.localId===e?(i={node:t,pos:o,fragmentMark:s},!1):t.attrs.localId!==e||(i={node:t,pos:o,fragmentMark:s},!1)})),i},H=(e,t)=>{const{tableCell:o,tableHeader:n,tableRow:r}=e.nodes,a=[],i=[];for(let d=0;d<3;d++){const e=o.createAndFill();e&&a.push(e);const t=n.createAndFill();t&&i.push(t)}const s=[];for(let d=0;d<3;d++)s.push(r.createChecked(null,0===d?i:a));return s},G=(e,t)=>{const{bodiedExtension:o,paragraph:n}=e.nodes;return t===o?[n.createChecked()]:g.Fragment.empty},B=(e,t,o,n,r)=>{var a;n=null!==(a=n)&&void 0!==a?a:o.tr;const i=Z(e,o),s=i?i.pos+i.node.nodeSize:void 0;return n=(0,C.Z3)(t,s)(n)},q=(e,t)=>{var o;return null!==(o=null==t?void 0:t.reduce(((t,o)=>{var n;const r=null===(n=e.getById(o))||void 0===n?void 0:n.normalizedId;return r?t.add(r):t}),new Set))&&void 0!==o?o:new Set},W=(e,t,o)=>n=>j(e,t.node,t.pos,o,t.dataConsumer)(n),j=(e,t,o,n,r)=>a=>{var i,s;const{dataConsumer:d}=e.marks,c=null===(i=null!=r?r:d.isInSet(t.marks))||void 0===i?void 0:i.attrs.sources;if(!(null!=n&&n.size||null!=c&&c.length))return a;if((null==n?void 0:n.size)===(null==c?void 0:c.length)&&c.every((e=>n.has(e))))return a;const l=(null!==(s=null==d?void 0:d.removeFromSet(t.marks))&&void 0!==s?s:t.marks).concat();return null!=n&&n.size&&l.push(d.create({sources:Array.from(n)})),a.setNodeMarkup(o,void 0,t.attrs,l),a},K=(e,t,o)=>n=>{var r,a,i,s,d;const{fragment:c}=e.marks;if(o===(null===(r=t.fragmentMark)||void 0===r?void 0:r.attrs.name))return n;const l=(null!==(a=null===(i=t.fragmentMark)||void 0===i?void 0:i.removeFromSet(t.node.marks))&&void 0!==a?a:t.node.marks).concat();return l.push(c.create({localId:null!==(s=null===(d=t.fragmentMark)||void 0===d?void 0:d.attrs.localId)&&void 0!==s?s:E.V.generate(),name:o})),n.setNodeMarkup(t.pos,void 0,t.node.attrs,l)},$=(e,t,o,r)=>{const a=e.schema.nodes[t.type];if(!U(e.schema).has(a))throw new k(t.type);const i=E.V.generate();if(e.hasId(i))throw new D(i);let s;"table"!==t.type&&(s=t.attrs);const{markNameWithNumber:d}=V({type:a,attrs:s},e.schema,e.getMaxNumberUsedInFragmentMarkNames(),o),c=((e,t,o,r)=>{const{table:a}=e.nodes,i=t===a?H:G;return t.createChecked((0,n.Z)((0,n.Z)({},o),{},{localId:E.V.generate()}),i(e,t),r)})(e.schema,a,s,((e,t,o,n)=>{var r;const{fragment:a,dataConsumer:i}=e.marks;return[a.create({localId:t,name:o}),n&&i.create({sources:null!==(r=Array.from(n))&&void 0!==r?r:[]})].filter(Boolean)})(e.schema,i,d,r)),{inlineExtension:l,paragraph:u}=e.schema.nodes,h=a===l?u.create(void 0,[c]):c;return{linkNode:F(i,d,c),node:h}},J=(e,t,o,n)=>{var r;const a=e.getById(t);if(!a)throw new P(t);const i=e.getById(o);if(!i)throw new z(o);if(a.normalizedId===i.normalizedId)throw new _(t,o);if(!(null===(r=a.dataConsumer)||void 0===r||!r.attrs.sources.some((e=>i.ids.has(e)))))return{target:L(a),source:L(i),tr:n};{var s;if(x(e,a,i))throw new _(t,o);const r=q(e,null===(s=a.dataConsumer)||void 0===s?void 0:s.attrs.sources);r.add(i.normalizedId),n=W(e.schema,a,r)(n)}return{target:L(a),source:L(i),tr:n}},X=(e,t,o,n)=>{var r;const a=e.getById(o);if(!a)throw new z(o);const i=e.getById(t);if(!i)throw new P(t);const s=q(e,null===(r=i.dataConsumer)||void 0===r?void 0:r.attrs.sources);return s.delete(a.normalizedId)?W(e.schema,i,s)(n):n},Q=(e,t,o,n,r,a)=>{const i=e.schema.nodes[o.type];if(!U(e.schema).has(i))throw new k(o.type);if(!e.hasId(t))throw new z(t);const{linkNode:s,node:d}=$(e,o,r,[e.getById(t).normalizedId]);return a&&(n=X(e,a,t,n)),{linkNode:s,tr:n=B(t,d,e.state,n)}};class Y{constructor(e,t,o=!0){(0,d.Z)(this,"maxNumberUsedInFragmentMarkName",{}),(0,d.Z)(this,"connections",new Map),(0,d.Z)(this,"uniqueNormalizedIds",new Set),(0,d.Z)(this,"uniqueSourceNormalizedIds",new Set),(0,d.Z)(this,"namelessNormalizedIds",new Set),this.view=e,this.normalizeLocalId=t,this.shallow=o;const{doc:n,schema:r}=this.view.state,{fragment:a,dataConsumer:i}=r.marks,s=U(r),c=new Map;n.descendants(((e,t,n)=>{var r,d,l,u,h,m,p;if(!s.has(e.type))return!0;const v=a.isInSet(e.marks);if(!(v||null!==(r=e.attrs)&&void 0!==r&&r.localId))return!0;const N=this.normalizeLocalId(null===(d=e.attrs)||void 0===d?void 0:d.localId,null==v||null===(l=v.attrs)||void 0===l?void 0:l.localId);if(!N||this.connections.has(N))return!0;let y;if(null!=v&&v.attrs.name){if(y=(e=>{const t=e.split(" ");if(t.length<2)return null;const o=Number(t[t.length-1]);return"number"!=typeof o?null:{defaultName:t.slice(0,t.length-1).join(" "),defaultNameNumber:o}})(v.attrs.name),y){const e=this.maxNumberUsedInFragmentMarkName[y.defaultName];(void 0===e||e<y.defaultNameNumber)&&(this.maxNumberUsedInFragmentMarkName[y.defaultName]=y.defaultNameNumber)}}else this.namelessNormalizedIds.add(N);const I=i.isInSet(e.marks),w={node:e,pos:t,parent:n,normalizedId:N,name:null!==(u=null==v||null===(h=v.attrs)||void 0===h?void 0:h.name)&&void 0!==u?u:N,ids:new Set,targets:new Set,fragmentMark:v,dataConsumer:I,decodedName:y};return null!=v&&null!==(m=v.attrs)&&void 0!==m&&m.localId&&(w.ids.add(v.attrs.localId),this.connections.set(v.attrs.localId,w)),null!==(p=e.attrs)&&void 0!==p&&p.localId&&(w.ids.add(e.attrs.localId),this.connections.set(e.attrs.localId,w)),this.uniqueNormalizedIds.add(N),I&&I.attrs.sources.forEach((e=>{var t,o;return c.set(e,null!==(t=null===(o=c.get(e))||void 0===o?void 0:o.add(N))&&void 0!==t?t:new Set([N]))})),!(o&&I)}));for(const[d,l]of c){const e=this.connections.get(d);e&&(this.uniqueSourceNormalizedIds.add(e.normalizedId),e.targets=new Set([...e.targets,...l]))}}get state(){return this.view.state}get schema(){return this.view.state.schema}getById(e){return this.connections.get(e)}hasId(e){return this.connections.has(e)}getMaxNumberUsedInFragmentMarkNames(){return(0,n.Z)({},this.maxNumberUsedInFragmentMarkName)}getMaxNumberUsedInFragmentMarkName(e){var t;return null!==(t=this.maxNumberUsedInFragmentMarkName[e])&&void 0!==t?t:0}updateMaxNumberUsedInFragmentMarkNames(e,t){this.maxNumberUsedInFragmentMarkName[e]=t}*uniqueConnections(){for(const e of this.uniqueNormalizedIds){const t=this.connections.get(e);t&&(yield t)}}*consumerOnlyConnections(){for(const t of this.uniqueNormalizedIds){var e;const o=this.connections.get(t);o&&null!==(e=o.dataConsumer)&&void 0!==e&&e.attrs.sources.length&&(yield o)}}*sourceOnlyConnections(){for(const e of this.uniqueSourceNormalizedIds){const t=this.connections.get(e);t&&(yield t)}}*namelessOnlyConnections(){for(const e of this.namelessNormalizedIds){const t=this.connections.get(e);t&&(yield t)}}}var ee=o(959557);const te=({docSize:e,sourceNodeType:t,targetNodeType:o,type:n,actionType:r,tr:a,editorAnalyticsAPI:i})=>s=>{const d={action:ee.om.CONNECTED_NODES,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:s,docSize:e,sourceNodeType:t,targetNodeType:o,type:n,actionType:r},eventType:ee.Ze.OPERATIONAL};null==i||i.attachAnalyticsEvent(d)(a)},oe=({docSize:e,oldSourceNodeType:t,newSourceNodeType:o,type:n,tr:r,editorAnalyticsAPI:a})=>i=>{const s={action:ee.om.UPDATED_SOURCE,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:i,docSize:e,oldSourceNodeType:t,newSourceNodeType:o,type:n},eventType:ee.Ze.OPERATIONAL};null==a||a.attachAnalyticsEvent(s)(r)},ne=({docSize:e,newTargetNodeType:t,oldTargetNodeType:o,sourceNodeType:n,type:r,tr:a,editorAnalyticsAPI:i})=>s=>{const d={action:ee.om.UPDATED_TARGET,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:s,docSize:e,newTargetNodeType:t,oldTargetNodeType:o,sourceNodeType:n,type:r},eventType:ee.Ze.OPERATIONAL};null==i||i.attachAnalyticsEvent(d)(a)};class re{constructor({nodeNameCallback:e,nodeFocusCallback:t,editorAnalyticsAPI:o,editorView:n,featureFlags:r}={}){this.nodeNameCallback=e,this.nodeFocusCallback=t,this.editorAnalyticsAPI=o,this.editorView=n,this.normalizeLocalId=(e,t)=>null!=r&&r["confluence.frontend.ecosystem.insert.fragment-mark"]&&null!=t?t:e}get isAttached(){return!!this.editorView}attach(e){const{state:{schema:t}}=e;if(!t.marks.fragment)throw new b("fragmentMark not supported");this.editorView=e}detach(){this.editorView=void 0}setNodeFocusCallback(e){this.nodeFocusCallback=e}setNodeNameCallback(e){this.nodeNameCallback=e}setSelectedLocalId(e){if(this.selectedLocalId!==e&&(this.selectedLocalId=e,this.nodeFocusCallback)){if(!e)return void this.nodeFocusCallback(void 0);if(this.editorView){const{state:n}=this.editorView,r=Z(e,n);var t,o;if(r)this.nodeFocusCallback(F(this.normalizeLocalId(e,null===(t=r.fragmentMark)||void 0===t?void 0:t.attrs.localId),(null===(o=r.fragmentMark)||void 0===o?void 0:o.attrs.name)||"",r.node))}}}initialiseFragmentMarks(){if(!this.editorView)throw new O("initialiseFragmentMarks");(0,f.MZ)(A.INITIALISE_FRAGMENT_MARKS);const{state:e,dispatch:t}=this.editorView;let{tr:o}=e;const n=e.doc.nodeSize,r=new Y(this.editorView,this.normalizeLocalId,!1);let a=0;const i=r.getMaxNumberUsedInFragmentMarkNames();for(const s of r.namelessOnlyConnections()){const{markNameWithNumber:t,markName:n,markNameNumber:r}=V(s.node,e.schema,i,this.nodeNameCallback);i[n]=r,o=K(e.schema,s,t)(o),a++}o.setMeta("addToHistory",!1),(0,f.H0)(A.INITIALISE_FRAGMENT_MARKS,(({docSize:e,count:t,tr:o,editorAnalyticsAPI:n})=>r=>{const a={action:ee.om.INITIALISED_FRAGMENT_MARK,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:r,docSize:e,count:t},eventType:ee.Ze.OPERATIONAL};null==n||n.attachAnalyticsEvent(a)(o)})({docSize:n,count:a,tr:o,editorAnalyticsAPI:this.editorAnalyticsAPI})),t(o)}getConnections(){(0,f.MZ)(A.GET_CONNECTIONS);const e={};if(!this.editorView)return(0,f.H0)(A.GET_CONNECTIONS),e;const{state:{tr:t,doc:{nodeSize:o}}}=this.editorView,n=new Y(this.editorView,this.normalizeLocalId);for(const{node:r,normalizedId:a,name:i}of n.uniqueConnections())e[a]=R(r,a,i);for(const{normalizedId:r,dataConsumer:a}of n.consumerOnlyConnections()){const t=e[r];a.attrs.sources.forEach((o=>{var a,i;const s=null!==(a=null===(i=n.getById(o))||void 0===i?void 0:i.normalizedId)&&void 0!==a?a:o,d=e[s];d&&s!==r&&(d.targets.push(r),null==t||t.sources.push(s))}))}return(0,f.H0)(A.GET_CONNECTIONS,(({count:e,docSize:t,tr:o,editorAnalyticsAPI:n})=>r=>{const a={action:ee.om.GOT_CONNECTIONS,actionSubject:ee.Wt.DOCUMENT,attributes:{docSize:t,duration:r,count:e},eventType:ee.Ze.OPERATIONAL};null==n||n.attachAnalyticsEvent(a)(o)})({tr:t,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:o,count:Object.keys(e).length})),e}select(e,t=!1){if(!this.editorView||!e)throw new O("select");const{state:o,dispatch:n}=this.editorView,r=Z(e,o);if(r){const{tr:e}=o;e.setSelection(a.NodeSelection.create(o.doc,r.pos)),t&&e.scrollIntoView(),e.setMeta("addToHistory",!1),n(e)}}updateName(e,t){try{var o;if((0,f.MZ)(A.UPDATE_FRAGMENT_MARK_NAME),!this.isAttached||!this.editorView)throw new O("updateName");const{state:n,state:{schema:r},dispatch:a}=this.editorView,i=Z(e,n);if(!i)throw new M(e);const{fragment:s}=r.marks,{fragmentMark:d,node:c,pos:l}=i,u=null!==(o=null==d?void 0:d.attrs.localId)&&void 0!==o?o:E.V.generate(),h=s.create({localId:u,name:t}),m=d?c.marks.filter((e=>e.type!==h.type)):c.marks.concat();m.push(h);let p=n.tr.setNodeMarkup(l,void 0,c.attrs,m);a(p);const v=F(this.normalizeLocalId(c.attrs.localId,u),t,c);return(0,f.H0)(A.UPDATE_FRAGMENT_MARK_NAME,(({nodeType:e,tr:t,editorAnalyticsAPI:o})=>n=>{const r={action:ee.om.UPDATED_FRAGMENT_MARK_NAME,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:n,nodeType:e},eventType:ee.Ze.OPERATIONAL};null==o||o.attachAnalyticsEvent(r)(t)})({tr:p,editorAnalyticsAPI:this.editorAnalyticsAPI,nodeType:c.type.name})),v}catch(n){throw(0,f.H0)(A.UPDATE_FRAGMENT_MARK_NAME),n}}getADFFromLocalId(e){if(!this.isAttached||!this.editorView)throw new O("getADFFromLocalId");const{state:t}=this.editorView,o=Z(e,t);if(!o)throw new M(e);return(new S.JSONTransformer).encodeNode(o.node)}connectSource(e,t){try{if((0,f.MZ)(A.CONNECT_NODES),!this.editorView)throw new O("connectSource");const{dispatch:o,state:n}=this.editorView,r=n.doc.nodeSize,a=new Y(this.editorView,this.normalizeLocalId),{source:i,target:s,tr:d}=J(a,e,t,n.tr);return o(d),(0,f.H0)(A.CONNECT_NODES,te({tr:d,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:r,actionType:"connectSource",type:"connect",sourceNodeType:i.node.type,targetNodeType:s.node.type})),i}catch(o){throw(0,f.H0)(A.CONNECT_NODES),o}}connectTarget(e,t){try{if((0,f.MZ)(A.CONNECT_NODES),!this.editorView)throw new O("connectTarget");const{dispatch:o,state:n}=this.editorView,r=n.doc.nodeSize,a=new Y(this.editorView,this.normalizeLocalId),{source:i,target:s,tr:d}=J(a,t,e,n.tr);return o(d),(0,f.H0)(A.CONNECT_NODES,te({tr:d,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:r,actionType:"connectTarget",type:"connect",sourceNodeType:i.node.type,targetNodeType:s.node.type})),s}catch(o){throw(0,f.H0)(A.CONNECT_NODES),o}}updateTarget(e,t,o){try{var n;if((0,f.MZ)(A.UPDATE_TARGET),!this.editorView)throw new O("updateTarget");const{dispatch:r,state:a}=this.editorView,i=a.doc.nodeSize,s=new Y(this.editorView,this.normalizeLocalId),{target:d,source:c,tr:l}=J(s,o,e,X(s,t,e,a.tr));return r(l),(0,f.H0)(A.UPDATE_TARGET,ne({tr:l,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:i,newTargetNodeType:d.node.type,oldTargetNodeType:(null===(n=s.getById(t))||void 0===n?void 0:n.node.type.name)||"",sourceNodeType:c.node.type,type:"update"})),d}catch(r){throw(0,f.H0)(A.UPDATE_TARGET),r}}updateSource(e,t){try{if((0,f.MZ)(A.UPDATE_SOURCE),!this.editorView)throw new O("updateSource");const{dispatch:o,state:n}=this.editorView,r=n.doc.nodeSize,a=new Y(this.editorView,this.normalizeLocalId),{target:i,source:s,tr:d}=((e,t,o,n)=>{var r;const a=e.getById(t);if(!a)throw new P(t);const i=e.getById(o);if(!i)throw new z(o);if(a.normalizedId===i.normalizedId)throw new _(t,o);if(null!==(r=a.dataConsumer)&&void 0!==r&&r.attrs.sources.every((e=>i.ids.has(e))))return{target:L(a),source:L(i),tr:n};if(x(e,a,i))throw new _(t,o);return n=W(e.schema,a,new Set([i.normalizedId]))(n),{target:L(a),source:L(i),tr:n}})(a,e,t,n.tr);return o(d),(0,f.H0)(A.UPDATE_SOURCE,oe({tr:d,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:r,oldSourceNodeType:i.node.type,newSourceNodeType:s.node.type,type:"update"})),s}catch(o){throw(0,f.H0)(A.UPDATE_SOURCE),o}}disconnectTarget(e,t){try{var o,n;if((0,f.MZ)(A.DISCONNECT_TARGET),!this.editorView)throw new O("disconnectTarget");const{dispatch:r,state:a}=this.editorView,i=a.doc.nodeSize,s=new Y(this.editorView,this.normalizeLocalId),d=X(s,t,e,a.tr);r(d),(0,f.H0)(A.DISCONNECT_TARGET,(({docSize:e,sourceNodeType:t,targetNodeType:o,tr:n,editorAnalyticsAPI:r})=>a=>{const i={action:ee.om.DISCONNECTED_TARGET,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:a,docSize:e,sourceNodeType:t,targetNodeType:o},eventType:ee.Ze.OPERATIONAL};null==r||r.attachAnalyticsEvent(i)(n)})({tr:d,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:i,sourceNodeType:(null===(o=s.getById(e))||void 0===o?void 0:o.node.type.name)||"",targetNodeType:(null===(n=s.getById(t))||void 0===n?void 0:n.node.type.name)||""}))}catch(r){throw(0,f.H0)(A.DISCONNECT_TARGET),r}}disconnectSource(e){try{if((0,f.MZ)(A.DISCONNECT_SOURCE),!this.editorView)throw new O("disconnectSource");const{dispatch:t,state:o}=this.editorView,n=o.doc.nodeSize,r=Z(e,o);if(!r)throw new P(e);const a=j(o.schema,r.node,r.pos)(o.tr);t(a),(0,f.H0)(A.DISCONNECT_SOURCE,(({docSize:e,targetNodeType:t,tr:o,editorAnalyticsAPI:n})=>r=>{const a={action:ee.om.DISCONNECTED_SOURCE,actionSubject:ee.Wt.DOCUMENT,attributes:{duration:r,docSize:e,targetNodeType:t},eventType:ee.Ze.OPERATIONAL};null==n||n.attachAnalyticsEvent(a)(o)})({tr:a,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:n,targetNodeType:r.node.type.name}))}catch(t){throw(0,f.H0)(A.DISCONNECT_SOURCE),t}}insertAndConnectTarget(e,t){try{var o;if((0,f.MZ)(A.CONNECT_NODES),!this.editorView)throw new O("insertAndConnectTarget");const{dispatch:n,state:r}=this.editorView,a=new Y(this.editorView,this.normalizeLocalId),{linkNode:i,tr:s}=Q(a,e,t,r.tr,this.nodeNameCallback);n(s);const d=s.doc.nodeSize;return(0,f.H0)(A.CONNECT_NODES,te({tr:s,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:d,actionType:"connectTarget",type:"insertAndConnect",sourceNodeType:(null===(o=a.getById(e))||void 0===o?void 0:o.node.type.name)||"",targetNodeType:t.type})),i}catch(n){throw(0,f.H0)(A.CONNECT_NODES),n}}insertAndConnectSource(e,t){try{var o,n;if((0,f.H0)(A.CONNECT_NODES),!this.editorView)throw new O("insertAndConnectSource");const{state:r,dispatch:a}=this.editorView,i=r.schema.nodes[t.type];if(!U(r.schema).has(i))throw new k(t.type);const s=new Y(this.editorView,this.normalizeLocalId),d=s.getById(e);if(!d)throw new P(e);const{linkNode:c,node:l}=$(s,t,this.nodeNameCallback);let u=r.tr;const h=q(s,null===(o=d.dataConsumer)||void 0===o?void 0:o.attrs.sources).add(c.localId);u=W(r.schema,d,h)(u),u=B(e,l,r,u),a(u);const m=u.doc.nodeSize;return(0,f.H0)(A.CONNECT_NODES,te({tr:u,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:m,actionType:"connectSource",type:"insertAndConnect",sourceNodeType:l.type.name,targetNodeType:(null===(n=s.getById(e))||void 0===n?void 0:n.node.type.name)||""})),c}catch(r){throw(0,f.H0)(A.CONNECT_NODES),r}}replaceAndUpdateTarget(e,t,o){try{var n,r;if((0,f.H0)(A.UPDATE_TARGET),!this.editorView)throw new O("replaceAndUpdateTarget");const{dispatch:a,state:i}=this.editorView,s=new Y(this.editorView,this.normalizeLocalId),{linkNode:d,tr:c}=Q(s,e,o,i.tr,this.nodeNameCallback,t);a(c);const l=c.doc.nodeSize;return(0,f.H0)(A.UPDATE_TARGET,ne({tr:c,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:l,type:"replaceAndUpdate",newTargetNodeType:o.type,oldTargetNodeType:(null===(n=s.getById(t))||void 0===n?void 0:n.node.type.name)||"",sourceNodeType:(null===(r=s.getById(e))||void 0===r?void 0:r.node.type.name)||""})),d}catch(a){throw(0,f.H0)(A.UPDATE_TARGET),a}}replaceAndUpdateSource(e,t){try{if((0,f.MZ)(A.UPDATE_SOURCE),!this.editorView)throw new O("replaceAndUpdateSource");const{state:{schema:o},state:n,dispatch:r}=this.editorView,a=o.nodes[t.type];if(!U(o).has(a))throw new k(t.type);const i=new Y(this.editorView,this.normalizeLocalId),s=i.getById(e);if(!s)throw new P(e);const{linkNode:d,node:c}=$(i,t,this.nodeNameCallback);let l=W(i.schema,s,new Set([d.localId]))(n.tr);l=B(e,c,n,l),r(l);const u=l.doc.nodeSize;return(0,f.H0)(A.UPDATE_SOURCE,oe({tr:l,editorAnalyticsAPI:this.editorAnalyticsAPI,docSize:u,oldSourceNodeType:s.node.type.name,newSourceNodeType:t.type,type:"replaceAndUpdate"})),d}catch(o){throw(0,f.H0)(A.UPDATE_SOURCE),o}}}var ae=o(429185);const ie=new S.JSONTransformer,se=(0,ae.Z)((e=>ie.encodeNode(e)));const de=e=>({name:"referentiality",pmPlugins:()=>[{name:"referentiality",plugin:({providerFactory:t,portalProviderAPI:o,eventDispatcher:a})=>{var d,m;return function(e,t,o,a,d,m={},p){return new r.J({key:i,state:{init(){const e=new c,t=new l(e);return d.forEach((t=>t.init({emit:(t,o)=>e.createOrUpdate(t,o)}))),{dataSourceProvider:e,nodeMutationObserver:t,changedSources:new Map,selectedNodeLocalId:void 0}},apply(e,t,o,r){let a=t.selectedNodeLocalId;if(p&&!o.selection.eq(r.selection)){var i;const t=(e=>{const{table:t,extension:o,bodiedExtension:n,inlineExtension:r}=e.nodes;return[t,o,n,r]})(o.schema),{fragment:n}=o.schema.marks,r=(0,C.a1)(t)(e.selection)||(0,C.Tr)(t)(e.selection);a=(null==r?void 0:r.node)&&((null==n||null===(i=n.isInSet(null==r?void 0:r.node.marks))||void 0===i?void 0:i.attrs.localId)||(null==r?void 0:r.node.attrs.localId))}const s=a!==t.selectedNodeLocalId;if(!e.docChanged)return s?(0,n.Z)((0,n.Z)({},t),{},{selectedNodeLocalId:a}):t;const d=new Map(t.changedSources),c=(0,h.qh)(e).filter((({node:t})=>"cut"!==e.getMeta("uiEvent")&&((e,t)=>{var o,n;const r="string"==typeof e.type?e.type:e.type.name;return[null===(o=t.nodes.table)||void 0===o?void 0:o.name].includes(r)&&(null===(n=e.attrs)||void 0===n?void 0:n.localId)})(t,o.schema)&&(e=>{try{return e.check(),!0}catch(t){return!1}})(t)));return c.forEach((({node:e})=>{var t,o,n,r;const a=null==e||null===(t=e.marks)||void 0===t||null===(o=t.find((e=>"fragment"===e.type.name)))||void 0===o||null===(n=o.attrs)||void 0===n?void 0:n.localId;a&&d.set(a,e),d.set(null==e||null===(r=e.attrs)||void 0===r?void 0:r.localId,e)})),c.length?(0,n.Z)((0,n.Z)({},t),{},{changedSources:d,selectedNodeLocalId:a}):s?(0,n.Z)((0,n.Z)({},t),{},{selectedNodeLocalId:a}):t}},view:e=>{null==p||p.attach(e);const t=e.state.schema.nodes.table,o=s(e.state);if(!o)return{};let n;const r=o.dataSourceProvider,i=o.nodeMutationObserver;return r&&(n=o=>{if(o&&o.attrs){let n=!1;(0,C.D0)(e.state.doc,t).forEach((({node:e})=>{e.attrs.localId===o.attrs.localId&&(n=!0)})),n||r.delete(o.attrs.localId)}},a.on(u,n)),i&&(0,C.D0)(e.state.doc,t).forEach((({node:e})=>{i.emit(e.attrs.localId,{get[T.TABLE](){return se(e)}})})),{update(e,t){const o=s(e.state);if(!o)return;const n=s(t),{changedSources:r,nodeMutationObserver:a,selectedNodeLocalId:i}=o;i!==(null==n?void 0:n.selectedNodeLocalId)&&(null==p||p.setSelectedLocalId(i)),r.forEach(((e,t)=>{a.emit(t,{get[T.TABLE](){return se(e)}})})),r.clear()},destroy(){null==p||p.detach(),r&&(a.off(u,n),r.clear&&r.clear())}}},props:{nodeViews:{extension:(n,r,i)=>{const d=s(r.state);return new w(n,r,i,o,a,{appearance:m.appearance,providerFactory:e,extensionHandlers:t,dataSourceProvider:null==d?void 0:d.dataSourceProvider},void 0,void 0,void 0,!0).init()},bodiedExtension:(n,r,i)=>{const d=s(r.state);return new w(n,r,i,o,a,{appearance:m.appearance,providerFactory:e,extensionHandlers:t,dataSourceProvider:null==d?void 0:d.dataSourceProvider},void 0,void 0,void 0,!0).init()},inlineExtension:(n,r,i)=>{const d=s(r.state);return new w(n,r,i,o,a,{appearance:m.appearance,providerFactory:e,extensionHandlers:t,dataSourceProvider:null==d?void 0:d.dataSourceProvider},void 0,void 0,void 0,!0).init()}}}})}(t,null!==(d=null==e?void 0:e.extensionHandlers)&&void 0!==d?d:{},o,a,null!==(m=null==e?void 0:e.externalObservers)&&void 0!==m?m:[],{appearance:null==e?void 0:e.appearance},null==e?void 0:e.api)}}]}),ce=e=>{var t;const o=null!==(t=null==e?void 0:e.api)&&void 0!==t?t:new re(e);return{api:o,plugin:de((0,n.Z)((0,n.Z)({},e),{},{api:o}))}},le=e=>{var t;const o=null==e||null===(t=e._privateGetEditorView())||void 0===t?void 0:t.state;if(!o)return null;const n=o.selection;if(n instanceof a.NodeSelection){var r,i,d,c;const e=null===(r=n.node.marks)||void 0===r||null===(i=r.find((e=>{var t,n;return e.type===(null===(t=o.schema)||void 0===t||null===(n=t.marks)||void 0===n?void 0:n.dataConsumer)})))||void 0===i||null===(d=i.attrs)||void 0===d?void 0:d.sources[0];if(!e)return null;const t=null===(c=s(o))||void 0===c?void 0:c.dataSourceProvider;return null==t?void 0:t.get(e)}},ue=(e=[])=>{let t=new Map;return e.forEach((e=>{var o,n,r;const a=null===(o=e.marks)||void 0===o?void 0:o.find((e=>"fragment"===e.type)),i=null==a||null===(n=a.attrs)||void 0===n?void 0:n.localId;i&&t.set(i,e),null!==(r=e.attrs)&&void 0!==r&&r.localId&&t.set(e.attrs.localId,e),e.content&&(t=new Map([...t,...ue(e.content)]))})),t},he=({adf:e,extensionParams:t,dataSourceProvider:o})=>{var n,r,a,i;const s=(0,m.useMemo)((()=>ue(e.content)),[e]),d=s.get(t.localId),c=null==d||null===(n=d.marks)||void 0===n||null===(r=n.find((e=>"dataConsumer"===e.type)))||void 0===r||null===(a=r.attrs)||void 0===a||null===(i=a.sources)||void 0===i?void 0:i[0],[l,u]=(0,m.useState)((()=>{const e=s.get(c);if("table"===(null==e?void 0:e.type))return{[T.TABLE]:e}}));return(0,m.useEffect)((()=>{if(c)return null==o||o.subscribe(c,u),()=>null==o?void 0:o.unsubscribe(c,u)}),[o,c]),{references:l?[l]:[]}}}}]);
//# sourceMappingURL=41232.SutPKH5TCK.js.map