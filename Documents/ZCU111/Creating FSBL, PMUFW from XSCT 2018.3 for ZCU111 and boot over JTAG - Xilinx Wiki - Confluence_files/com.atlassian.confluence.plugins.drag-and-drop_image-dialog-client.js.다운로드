WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.drag-and-drop:image-dialog-client', location = 'js/image-dialog-client.js' */
define("confluence-drag-and-drop/image-dialog-client","jquery ajs confluence/meta underscore confluence-drag-and-drop/files-uploader-factory confluence/legacy-editor-global-AVOID-IF-POSSIBLE confluence-drag-and-drop/insert-dialog-upload-controller confluence-drag-and-drop/upload-utils confluence-drag-and-drop/drag-and-drop-utils".split(" "),function(p,k,h,q,t,g,u,r,v){var m=function(){this._workIdToBytesUploaded={};this._totalBytes=0};m.prototype={update:function(a,f,e){a in this._workIdToBytesUploaded||
(this._totalBytes+=e);this._workIdToBytesUploaded[a]=f},percentComplete:function(){var a=0;p.each(this._workIdToBytesUploaded,function(f,e){a+=e});return Math.round(100*a/this._totalBytes)}};var n=t.get(),l=function(a){this.pageId=parseInt(h.get("page-id"),10);this.draftId=parseInt(h.get("draft-id"),10);this.dragAndDropEntityId=h.get("drag-and-drop-entity-id");this.spaceKey=h.get("space-key")||"";this.atlToken=h.get("atl-token");this.base=/^\w+:\/\/[^\/?#]+/.exec(location.href);this.metaMaxFileSize=
h.get("global-settings-attachment-max-size");this.errors=[];this.batchProgress=new m;this.attachmentPanelComponent=a.attachmentPanelComponent;this.dropZone=a.dropZone;this.browserButtonId=a.browserButtonId;this.uploader=null;this.isUploadUsingDragAndDrop=!1;var f=this;p(this.dropZone).bind("drop",function(){f.isUploadUsingDragAndDrop=!0})};l.prototype.createPlupload=function(){var a=this,f=function(c){if(c){var b,d;c.generalError?(d=[c.generalError.message],b=c.generalError.fileIds):c.fileErrors&&
(d=[],b=[],q.each(c.fileErrors,function(a){b.push(a.id);d.push(a.message)}));d&&d.length&&(a.attachmentPanelComponent.displayErrors(d),a.errors=a.errors.concat(d));b&&b.length&&q.each(b,function(b){a.attachmentPanelComponent.attachmentUploadingCancelled(b);a.cancelUpload(b)})}},e=new plupload.Uploader({runtimes:"html5",dragdrop:!0,drop_element:a.dropZone,browse_button:a.browserButtonId,multipart:!1,stop_propagation:!0,max_file_size:parseInt(a.metaMaxFileSize,10),inputFileClazz:"file-library-input-file"});
e.init();e.bind("Started",function(c,b){a.errors=[];a.attachmentPanelComponent.clearErrors();a.batchProgress=new m;require(["conf/confluence-drag-and-drop/analytics/files-upload-analytics"],function(c){c.triggerEvent(a.isUploadUsingDragAndDrop?"confluence.insert-files-dialog.drag-and-drop":"confluence.insert-files-dialog.upload",b);a.isUploadUsingDragAndDrop=!1})});e.bind("FilesAdded",function(c,b){function d(b,c){for(var d=0;d<c.length;d++)if(c[d].status===plupload.FAILED)b.removeFile(c[d]);else{var e=
q.find(b.files,function(a){return a.name===c[d].name&&a.id!==c[d].id});e&&b.removeFile(e);a.metaMaxFileSize>c[d].size&&a.attachmentPanelComponent.addPreviewImage(c[d])}n.filesAdded(b,c,a).then(function(a){f(a);b.start()})}0<b.length&&(a.attachmentPanelComponent.getNoFileContainer().hide(),r.filterFiles(c,b,d))});e.bind("BeforeUpload",function(c,b){n.beforeUpload(c,b,a);a.batchProgress=new m});e.bind("UploadProgress",function(c,b){a.batchProgress.update(b.id,b.loaded,b.size);a.attachmentPanelComponent.setUploadInProgress(a.batchProgress.percentComplete()/
100,b.id)});e.bind("FileUploaded",function(c,b,d){c.getFile(b.id)?n.fileUploaded(c,b,d).done(function(b){a.attachmentPanelComponent.attachmentUploaded(b.fileId,b.fileServerId)}).fail(function(a){f(a)}):a.attachmentPanelComponent.attachmentUploadingCancelled(b.id)});e.bind("Error",function(c,b){var d;b.response?(d=n.serverError(b.response)||b.message,a.attachmentPanelComponent.displayErrors([d]),a.errors.push(d),k.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.server-unknown"})):
(d=b.message,c=b.file.name,b.code===plupload.FILE_SIZE_ERROR?(b=v.niceSize(a.metaMaxFileSize).toString(),d=k.format("{0} is too big to upload. Files must be less than {1}.",c,b),k.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-size"})):b.code===r.ErrorCode.FILE_IS_A_FOLDER_ERROR&&(d=k.format("Cannot upload {0} - it might be a folder or an unsupported file type.",c),k.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-type"})),a.attachmentPanelComponent.displayErrors([d]),a.errors.push(d))});
require(["conf/confluence-drag-and-drop/drag-and-drop-overlay"],function(c){c.bindFileDragOverlay({$dragZone:p(a.dropZone),zIndex:3005})});return e};l.prototype.init=function(){this.uploader=this.createPlupload()};l.prototype.cancelUpload=function(a){(a=this.uploader.getFile(a))&&this.uploader.removeFile(a)};if(g&&g.FileDialog)g.FileDialog.eventListener.on("AttachmentsPanelView.render",function(a){a.getUploaderController=function(){return new u(a.context)}});k.toInit(function(a){if(g&&g.ImageDialog){a=
g.ImageDialog.beforeShowListeners;var f=g.ImageDialog.findPanelComponentById("attachments");a&&a.push(function(){if(f){var a=f.getPanelElement();if(a.length&&h.getBoolean("can-attach-files")){var c=new l({dropZone:a[0],browserButtonId:"upload-files-button",attachmentPanelComponent:f});c.init();g.FileDialog.eventListener.on("uploadingfile.cancelled",function(a){c.cancelUpload(a)})}}else console.debug("Do not support Attachment Panel and Drag-Drop in Insert Image Dialog (ex: in creating Template)")})}});
return l});require("confluence/module-exporter").safeRequire("confluence-drag-and-drop/image-dialog-client");
}catch(e){WRMCB(e)};