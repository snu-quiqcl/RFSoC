"use strict";(self._cf=self._cf||[]).push([[35657,79551],{350680:(e,t,n)=>{n.d(t,{z:()=>s,p:()=>i});var o=n(331377);const s=o.ZP`fragment ContentOperationsFragment on Content{id type operations{operation targetType}}`,i=o.ZP`fragment SpaceOperationsFragment on Space{id operations{operation targetType}}`},517105:(e,t,n)=>{n.d(t,{xP:()=>o,vt:()=>s});const o=({operationCheckResult:e,operation:t,contentType:n})=>{var o,s,i,r,a,c,l;const u=null!==(o=null==e||null===(s=e.content)||void 0===s||null===(i=s.nodes)||void 0===i||null===(r=i[0])||void 0===r?void 0:r.operations)&&void 0!==o?o:[],d=n||(null==e||null===(a=e.content)||void 0===a||null===(c=a.nodes)||void 0===c||null===(l=c[0])||void 0===l?void 0:l.type);return!!d&&u.some((e=>(null==e?void 0:e.operation)===t&&(null==e?void 0:e.targetType)===d))},s=({operationCheckResult:e,operation:t,contentType:n})=>{var o,s;return(null!==(o=null==e||null===(s=e.space)||void 0===s?void 0:s.operations)&&void 0!==o?o:[]).some((e=>(null==e?void 0:e.operation)===t&&(null==e?void 0:e.targetType)===n))}},488271:(e,t,n)=>{let o;n.d(t,{B:()=>o}),function(e){e.USE="use",e.LIMITED_USE="limited_use",e.EXTERNAL_COLLABORATOR_USE="external_collaborator_use",e.CREATE="create",e.READ="read",e.UPDATE="update",e.DELETE="delete",e.COPY="copy",e.MOVE="move",e.EXPORT="export",e.ARCHIVE="archive",e.PURGE="purge",e.PURGE_VERSION="purge_version",e.ADMINISTER="administer",e.RESTORE="restore",e.CREATE_SPACE="create_space",e.RESTRICT_CONTENT="restrict_content",e.CLEAR_PERMISSIONS="clear_permissions"}(o||(o={}))},622739:(e,t,n)=>{n.r(t),n.d(t,{ExternalUserLozengeProps:()=>u,ExternalUserLozenge:()=>d});var o=n(991332),s=n(122551),i=n(464984),r=n(883383),a=n(103206),c=n(57198);const l=(0,i.defineMessages)({externalUserLozengeText:{id:"external-collab-ui.user-guest-lozenge",defaultMessage:"Guest"},guestUserTooltip:{id:"external-collab-ui.user-guest-lozenge.tooltip",defaultMessage:"Guests can only access certain spaces and have limited access to user info."}}),u={text:s.createElement(c.Z,{content:s.createElement(r.Z,(0,o.Z)({},l.guestUserTooltip))},s.createElement(r.Z,(0,o.Z)({},l.externalUserLozengeText))),appearance:"new",isBold:!1},d=()=>{const{text:e,appearance:t,isBold:n}=u;return s.createElement(a.Z,{appearance:t,isBold:n},e)};d.displayName="ExternalUserLozenge"},910194:(e,t,n)=>{n.d(t,{$:()=>o});const o=n(331377).ZP`fragment ExternalCollaboratorEntitlementFragment on Query{entitlements{externalCollaborator{isEntitled}}}`},950535:(e,t,n)=>{n.d(t,{D:()=>o});const o=e=>null==e?void 0:e.entitlements.externalCollaborator.isEntitled},79551:(e,t,n)=>{n.d(t,{Z:()=>s});var o=n(348682);function s(e,t,n,s,i,r){return(0,o.vv)(e,t,n,s,i,r)}},668965:(e,t,n)=>{n.d(t,{R:()=>f});var o=n(991332),s=n(29298),i=n(845130),r=n(822814),a=n(978699),c=n(207976),l=n(572535),u=n(917068),d=n(622739),m=n(172033),h=n(415294);const p=(0,m.FO)({key:h.F6}),E="initialState",g="searchUser",v="succeeded",y="failed";class f extends i.ZP{constructor(e,t,n,o){super(t),(0,s.Z)(this,"userTeamEndpoint",void 0),(0,s.Z)(this,"teamMentionConfig",void 0),(0,s.Z)(this,"includeExternalCollaborators",void 0),this.teamMentionConfig=n,this.userTeamEndpoint=e,this.includeExternalCollaborators=o}async remoteInitialState(e){try{const t=await this.doSearch("",e);return this._notifyAnalyticsListeners(r.oX,E,v),t}catch(t){throw this._notifyAnalyticsListeners(r.oX,E,y),t}}async remoteSearch(e,t){try{const n=await this.doSearch(e,t);return this._notifyAnalyticsListeners(r.oX,g,v),n}catch(n){throw this._notifyAnalyticsListeners(r.oX,g,y),n}}mentionTypeaheadHighlightEnabled(){return!1}mentionTypeaheadCreateTeamPath(){return this.teamMentionConfig.createTeamPath}async doSearch(e,t){p.start();const n=await this.post(await this.cloudId(),await this.orgId(),e,t);if(!n.ok){const e=await n.json();throw p.stop({customData:{isExCoEnabled:this.includeExternalCollaborators,success:!1}}),new Error(JSON.stringify(e))}const o=(await n.json()).recommendedUsers.map((e=>this.isUser(e)?this.convertToUserMention(e):(this.isTeam(e),this.convertToTeamMention(e))));return p.stop({customData:{isExCoEnabled:this.includeExternalCollaborators,success:!0}}),{query:e,mentions:o}}async cloudId(){const{cloudId:e}=await(0,u.g)();return e}async orgId(){const{orgId:e}=await(0,l.Uu)();return e}async post(e,t,n,s){return await(0,c.y)(this.userTeamEndpoint,{method:"POST",headers:{"content-type":"application/json"},credentials:"include",body:JSON.stringify({context:(0,o.Z)((0,o.Z)({contextType:"Mentions",principalId:"context",productKey:s&&s.product||"confluence",siteId:e,containerId:s&&s.containerId,objectId:s&&s.objectId,childObjectId:s&&s.childObjectId,mentionsSessionId:s&&s.sessionId},t?{organizationId:t}:{}),this.includeExternalCollaborators?{productAttributes:{isEntitledConfluenceExternalCollaborator:!0}}:{}),searchQuery:(0,o.Z)({queryString:n},this.includeExternalCollaborators?{productAccessPermissionIds:["write","external-collaborator-write"]}:{}),maxNumberOfResults:20,includeTeams:!0})})}isUser(e){return"USER"===e.entityType}convertToUserMention(e){var t;return(0,o.Z)({id:e.id,name:e.name||e.nickname||"",mentionName:e.nickname||"",avatarUrl:e.avatarUrl,accessLevel:e.accessLevel,userType:e.userType},null!=e&&null!==(t=e.attributes)&&void 0!==t&&t.isConfluenceExternalCollaborator?{lozenge:d.ExternalUserLozengeProps}:{})}isTeam(e){return"TEAM"===e.entityType}convertToTeamMention(e){const{teamLinkResolver:t}=this.teamMentionConfig;let n="";const o=`${window.location.origin}/people/team/${e.id}`;return"function"==typeof t&&(n=t(e.id)),{id:e.id,name:e.displayName,mentionName:e.displayName,avatarUrl:e.smallAvatarImageUrl,accessLevel:a.kI[a.kI.CONTAINER],userType:a.FW[a.FW.TEAM],context:{members:e.members,includesYou:e.includesYou,memberCount:e.memberCount,teamLink:n||o}}}}},633954:(e,t,n)=>{n.d(t,{Z:()=>u});var o=n(315677),s=n(401487),i=n(596207),r=n(170915),a=n(331377),c=n(910194);const l=a.ZP`query MentionsProviderQuery{...ExternalCollaboratorEntitlementFragment}${c.$}`,u=async()=>(0,o.WQ)().query({query:l}).then((({data:e})=>e)).catch((e=>{(0,i.U)().submitError(e,{attribution:r.x.MISSION_CONTROL}),(0,s.Xb)(e)}))},348682:(e,t,n)=>{n.d(t,{OC:()=>p,vv:()=>E});var o=n(366185),s=n(513100),i=n(917068),r=n(755492),a=n(609145),c=n(950535),l=n(978699),u=n(207976);class d{getLookupLimit(){return 90}async lookupMentionNames(e){const t=e.reduce(((e,t,n)=>`${e}${n>0?"&":""}accountId=${encodeURIComponent(t)}`),"");return(0,u.y)(`/wiki/rest/api/user/bulk?${t}`,{credentials:"same-origin"}).then((e=>e.json())).then((e=>e&&e.results&&e.results.length?e.results.map((e=>({id:e.accountId,name:e.displayName,status:l.dP.OK}))):[]))}}var m=n(668965),h=n(633954);async function p(e,t,n,s,l,u){const{featureFlags:p}=await(0,i.g)(),E={url:`/gateway/api/mentions/${e}`,productId:"micros-group/confluence",containerId:t||void 0,shouldHighlightMention:e=>e.id===n,debounceTime:150};if(p[a.sH]){E.inviteExperimentCohort=p[a.sH];const e=(p[a.sH]==a.wG.VARIATION_HOME||p[a.sH]==a.wG.VARIATION_SOURCE)&&!!l;e&&(E.productName="Confluence",E.shouldEnableInvite=e,E.onInviteItemClick=l,E.userRole=u)}const g={url:"/gateway/api/teams/mentions",productId:"micros-group/confluence",shouldHighlightMention:e=>e.id===n};return E.mentionNameResolver=new o.j(new d,s),async function(e,t,n){let o=!1;if(n[r.pA]){const e=await(0,h.Z)();o=!0===(0,c.D)(e)}return new m.R("/gateway/api/v1/recommendations",e,t,o)}(E,g,p)}async function E(e,t,n,o,i,r){if(!e)throw new Error("MentionResource cannot be configured without a cloud id");const a=(null==n?void 0:n.spaceId)||void 0;return{mentionResource:await p(e,a,t,o,i,r),presenceResource:new s.ZP({url:"/gateway/api/directory/graphql",cloudId:e,productId:"confluence"}),mentionServiceUrl:`/gateway/api/mentions/${e}`,contextIdentifier:{containerId:a||"",objectId:(null==n?void 0:n.contentId)||"",childObjectId:(null==n?void 0:n.commentId)||""}}}},528365:(e,t,n)=>{n.d(t,{tl:()=>a,tv:()=>c,Oi:()=>l,es:()=>u,So:()=>d,_N:()=>h});var o=n(991332),s=n(917068),i=n(443033),r=n(596207);const a=e=>{window.performance&&window.performance.clearMarks&&e.forEach((e=>window.performance.clearMarks(e)))},c=e=>{if(window.performance&&window.performance.getEntriesByName){const t=window.performance.getEntriesByName(e);return t&&t[0]}},l=(e,t)=>{const n=c(e),o=c(t);if(n&&o)return Math.abs(n.startTime-o.startTime)},u=e=>{const t=c(e);if(t)return t.startTime},d=({subject:e,subjectId:t=""})=>{const n=`${e}.${t}.start`;a([n,`${e}.${t}.end`]),window.performance.mark(n)},m=async({details:e,subject:t,subjectId:n,includeFeatureFlags:a})=>{const c=`${t}.${n}.end`;window.performance.mark(c);const u=l(`${t}.${n}.start`,c);if(void 0!==u)try{const r=(0,i.getAnalyticsWebClient)(),c=a?(0,s.g)():Promise.resolve({featureFlags:{}}),[l,{featureFlags:d}]=await Promise.all([r,c]),m=((e={})=>Object.keys(e).filter((t=>e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{}))(d);l.sendOperationalEvent({tags:["performance"],source:"confluence-frontend",action:"done",actionSubject:t,actionSubjectId:n,attributes:(0,o.Z)({featureFlags:m,duration:u},e)})}catch(d){(0,r.U)().submitError(d,{attribution:"unknown"})}},h=({subject:e,subjectId:t="",details:n={},includeFeatureFlags:o=!1})=>{c(`${e}.${t}.end`)||m({details:n,includeFeatureFlags:o,subject:e,subjectId:t})}},492466:(e,t,n)=>{n.r(t),n.d(t,{ViewPage:()=>b});var o=n(991332),s=n(122551),i=n(325834),r=n(607213),a=n(933083),c=n(135654),l=n(542210),u=n(56237),d=n(998033),m=n(605524),h=n(483565),p=n(517105),E=n(488271),g=n(315677),v=n(247418),y=n(450855);var f=n(331377),w=n(350680);const I=f.ZP`query ViewPageEditorPreloadQuery($contentId:ID){content(id:$contentId){nodes{...ContentOperationsFragment metadata{frontend{embedded}}}}}${w.z}`,b=({contentId:e,spaceKey:t,classicComments:n,children:f})=>{const{createAnalyticsEvent:w}=(0,i._)(),[b,T]=(0,s.useState)({doPreload:!1,isEmbeddedEditor:!1}),{versionOverride:C}=(0,a.I)();(0,c.r)(e);const P=(0,s.useContext)(d.x),S=parseInt((0,h.hS)("confluence.frontend.fabric.editor.preload.timeout")||"10000",10);let x=null;e&&t&&(x=s.createElement(r.yW,{spaceKey:t,contentId:e,isSticky:!1,versionOverride:C})),(0,s.useEffect)((()=>((0,v.Z)({listener:"ViewPage",globalProperty:"AJS.bind"},(()=>{window.AJS.bind("createGASv3Event",((e,t)=>{w(t).fire()}))})),()=>{(0,v.Z)({listener:"ViewPage",globalProperty:"AJS.unbind"},(()=>{window.AJS.bind("createGASv3Event")}))})),[w]),(0,s.useEffect)((()=>{if(!S)return;const t=setTimeout((async()=>{const t=(await(0,g.WQ)().query({query:I,variables:{contentId:e}})).data,n=(0,p.xP)({operationCheckResult:t,operation:E.B.UPDATE});if((0,m.B)().shouldPreload(e)&&n){var o,s,i,r,a,c;const e=null!==(o=null==t||null===(s=t.content)||void 0===s||null===(i=s.nodes)||void 0===i||null===(r=i[0])||void 0===r||null===(a=r.metadata)||void 0===a||null===(c=a.frontend)||void 0===c?void 0:c.embedded)&&void 0!==o&&o;T({doPreload:!0,isEmbeddedEditor:e})}}),isFinite(S)?S:1e4);return()=>clearTimeout(t)}),[T,S,e]),(0,s.useEffect)((()=>()=>{b.doPreload&&(0,m.B)().removePreloadedId(e)}),[b.doPreload,e]);return(()=>{const{doPreload:i,isEmbeddedEditor:r}=(0,o.Z)({},b);return s.createElement(s.Fragment,null,s.createElement(l.$,{contentId:e}),s.createElement(u.j,{spaceKey:t,contentId:e,contentHeader:x,classicComments:n,hasPageComments:!0,hasLabels:!0,hasReactions:!0,hasInlineComments:!0,hasEOPRecs:!0},f,s.createElement(y.W,null)),P&&i&&P(e,t,r))})()}},366185:(e,t,n)=>{n.d(t,{j:()=>r});var o=n(29298),s=n(978699),i=n(822814);class r{constructor(e,t={}){(0,o.Z)(this,"nameCache",new Map),(0,o.Z)(this,"nameQueue",new Map),(0,o.Z)(this,"nameStartTime",new Map),(0,o.Z)(this,"processingQueue",new Map),(0,o.Z)(this,"debounce",0),(0,o.Z)(this,"processQueue",(()=>{clearTimeout(this.debounce),this.debounce=0;const{queue:e,extraQueue:t}=this.splitQueueAtLimit();this.nameQueue=t,this.processingQueue=new Map([...this.processingQueue,...e]),this.client.lookupMentionNames(Array.from(e.keys())).then((t=>{t.forEach((t=>{const{id:n}=t;e.delete(n),this.resolveQueueItem(t)})),e.forEach(((e,t)=>{this.resolveQueueItem({id:t,status:s.dP.UNKNOWN})}))})).catch((()=>{e.forEach(((e,t)=>{this.resolveQueueItem({id:t,status:s.dP.SERVICE_ERROR})}))})),this.nameQueue.size>0&&this.scheduleProcessQueue()})),this.client=e,this.fireHydrationEvent=(0,i.Ng)(t)}lookupName(e){const t=this.nameCache.get(e);return t?(this.fireAnalytics(!0,t),t):new Promise((t=>{const n=this.processingQueue.get(e);n&&this.processingQueue.set(e,[...n,t]);const o=this.nameQueue.get(e)||[];this.nameQueue.set(e,[...o,t]),0!==o.length||n||this.nameStartTime.set(e,Date.now()),this.scheduleProcessQueue(),this.isQueueAtLimit()&&this.processQueue()}))}cacheName(e,t){this.nameCache.set(e,{id:e,name:t,status:s.dP.OK})}scheduleProcessQueue(){this.debounce||(this.debounce=window.setTimeout(this.processQueue,r.waitForBatch))}isQueueAtLimit(){return this.nameQueue.size>=this.client.getLookupLimit()}splitQueueAtLimit(){const e=Array.from(this.nameQueue.entries()),t=this.client.getLookupLimit();return{queue:new Map(e.slice(0,t)),extraQueue:new Map(e.slice(t))}}resolveQueueItem(e){const{id:t}=e,n=this.processingQueue.get(t);n&&(this.processingQueue.delete(t),this.nameCache.set(t,e),n.forEach((t=>{try{t(e)}catch(n){}})),this.fireAnalytics(!1,e))}fireAnalytics(e,t){const{id:n}=t,o=t.status===s.dP.OK?"completed":"failed",i=this.nameStartTime.get(n),r=i?Date.now()-i:0;this.nameStartTime.delete(n),this.fireHydrationEvent(o,n,e,r)}}(0,o.Z)(r,"waitForBatch",100)}}]);
//# sourceMappingURL=35657.12dyvytVjp.js.map