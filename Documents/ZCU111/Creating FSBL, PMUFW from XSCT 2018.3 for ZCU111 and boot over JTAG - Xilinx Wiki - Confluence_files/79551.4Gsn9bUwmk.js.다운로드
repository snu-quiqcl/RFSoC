"use strict";(self._cf=self._cf||[]).push([[79551],{622739:(e,t,n)=>{n.r(t),n.d(t,{ExternalUserLozengeProps:()=>l,ExternalUserLozenge:()=>d});var s=n(991332),i=n(122551),o=n(464984),a=n(883383),r=n(103206),c=n(57198);const u=(0,o.defineMessages)({externalUserLozengeText:{id:"external-collab-ui.user-guest-lozenge",defaultMessage:"Guest"},guestUserTooltip:{id:"external-collab-ui.user-guest-lozenge.tooltip",defaultMessage:"Guests can only access certain spaces and have limited access to user info."}}),l={text:i.createElement(c.Z,{content:i.createElement(a.Z,(0,s.Z)({},u.guestUserTooltip))},i.createElement(a.Z,(0,s.Z)({},u.externalUserLozengeText))),appearance:"new",isBold:!1},d=()=>{const{text:e,appearance:t,isBold:n}=l;return i.createElement(r.Z,{appearance:t,isBold:n},e)};d.displayName="ExternalUserLozenge"},910194:(e,t,n)=>{n.d(t,{$:()=>s});const s=n(331377).ZP`fragment ExternalCollaboratorEntitlementFragment on Query{entitlements{externalCollaborator{isEntitled}}}`},950535:(e,t,n)=>{n.d(t,{D:()=>s});const s=e=>null==e?void 0:e.entitlements.externalCollaborator.isEntitled},79551:(e,t,n)=>{n.d(t,{Z:()=>i});var s=n(348682);function i(e,t,n,i,o,a){return(0,s.vv)(e,t,n,i,o,a)}},668965:(e,t,n)=>{n.d(t,{R:()=>w});var s=n(991332),i=n(29298),o=n(845130),a=n(822814),r=n(978699),c=n(207976),u=n(572535),l=n(917068),d=n(622739),m=n(172033),h=n(415294);const p=(0,m.FO)({key:h.F6}),g="initialState",y="searchUser",f="succeeded",I="failed";class w extends o.ZP{constructor(e,t,n,s){super(t),(0,i.Z)(this,"userTeamEndpoint",void 0),(0,i.Z)(this,"teamMentionConfig",void 0),(0,i.Z)(this,"includeExternalCollaborators",void 0),this.teamMentionConfig=n,this.userTeamEndpoint=e,this.includeExternalCollaborators=s}async remoteInitialState(e){try{const t=await this.doSearch("",e);return this._notifyAnalyticsListeners(a.oX,g,f),t}catch(t){throw this._notifyAnalyticsListeners(a.oX,g,I),t}}async remoteSearch(e,t){try{const n=await this.doSearch(e,t);return this._notifyAnalyticsListeners(a.oX,y,f),n}catch(n){throw this._notifyAnalyticsListeners(a.oX,y,I),n}}mentionTypeaheadHighlightEnabled(){return!1}mentionTypeaheadCreateTeamPath(){return this.teamMentionConfig.createTeamPath}async doSearch(e,t){p.start();const n=await this.post(await this.cloudId(),await this.orgId(),e,t);if(!n.ok){const e=await n.json();throw p.stop({customData:{isExCoEnabled:this.includeExternalCollaborators,success:!1}}),new Error(JSON.stringify(e))}const s=(await n.json()).recommendedUsers.map((e=>this.isUser(e)?this.convertToUserMention(e):(this.isTeam(e),this.convertToTeamMention(e))));return p.stop({customData:{isExCoEnabled:this.includeExternalCollaborators,success:!0}}),{query:e,mentions:s}}async cloudId(){const{cloudId:e}=await(0,l.g)();return e}async orgId(){const{orgId:e}=await(0,u.Uu)();return e}async post(e,t,n,i){return await(0,c.y)(this.userTeamEndpoint,{method:"POST",headers:{"content-type":"application/json"},credentials:"include",body:JSON.stringify({context:(0,s.Z)((0,s.Z)({contextType:"Mentions",principalId:"context",productKey:i&&i.product||"confluence",siteId:e,containerId:i&&i.containerId,objectId:i&&i.objectId,childObjectId:i&&i.childObjectId,mentionsSessionId:i&&i.sessionId},t?{organizationId:t}:{}),this.includeExternalCollaborators?{productAttributes:{isEntitledConfluenceExternalCollaborator:!0}}:{}),searchQuery:(0,s.Z)({queryString:n},this.includeExternalCollaborators?{productAccessPermissionIds:["write","external-collaborator-write"]}:{}),maxNumberOfResults:20,includeTeams:!0})})}isUser(e){return"USER"===e.entityType}convertToUserMention(e){var t;return(0,s.Z)({id:e.id,name:e.name||e.nickname||"",mentionName:e.nickname||"",avatarUrl:e.avatarUrl,accessLevel:e.accessLevel,userType:e.userType},null!=e&&null!==(t=e.attributes)&&void 0!==t&&t.isConfluenceExternalCollaborator?{lozenge:d.ExternalUserLozengeProps}:{})}isTeam(e){return"TEAM"===e.entityType}convertToTeamMention(e){const{teamLinkResolver:t}=this.teamMentionConfig;let n="";const s=`${window.location.origin}/people/team/${e.id}`;return"function"==typeof t&&(n=t(e.id)),{id:e.id,name:e.displayName,mentionName:e.displayName,avatarUrl:e.smallAvatarImageUrl,accessLevel:r.kI[r.kI.CONTAINER],userType:r.FW[r.FW.TEAM],context:{members:e.members,includesYou:e.includesYou,memberCount:e.memberCount,teamLink:n||s}}}}},633954:(e,t,n)=>{n.d(t,{Z:()=>l});var s=n(315677),i=n(401487),o=n(596207),a=n(170915),r=n(331377),c=n(910194);const u=r.ZP`query MentionsProviderQuery{...ExternalCollaboratorEntitlementFragment}${c.$}`,l=async()=>(0,s.WQ)().query({query:u}).then((({data:e})=>e)).catch((e=>{(0,o.U)().submitError(e,{attribution:a.x.MISSION_CONTROL}),(0,i.Xb)(e)}))},348682:(e,t,n)=>{n.d(t,{OC:()=>p,vv:()=>g});var s=n(366185),i=n(513100),o=n(917068),a=n(755492),r=n(609145),c=n(950535),u=n(978699),l=n(207976);class d{getLookupLimit(){return 90}async lookupMentionNames(e){const t=e.reduce(((e,t,n)=>`${e}${n>0?"&":""}accountId=${encodeURIComponent(t)}`),"");return(0,l.y)(`/wiki/rest/api/user/bulk?${t}`,{credentials:"same-origin"}).then((e=>e.json())).then((e=>e&&e.results&&e.results.length?e.results.map((e=>({id:e.accountId,name:e.displayName,status:u.dP.OK}))):[]))}}var m=n(668965),h=n(633954);async function p(e,t,n,i,u,l){const{featureFlags:p}=await(0,o.g)(),g={url:`/gateway/api/mentions/${e}`,productId:"micros-group/confluence",containerId:t||void 0,shouldHighlightMention:e=>e.id===n,debounceTime:150};if(p[r.sH]){g.inviteExperimentCohort=p[r.sH];const e=(p[r.sH]==r.wG.VARIATION_HOME||p[r.sH]==r.wG.VARIATION_SOURCE)&&!!u;e&&(g.productName="Confluence",g.shouldEnableInvite=e,g.onInviteItemClick=u,g.userRole=l)}const y={url:"/gateway/api/teams/mentions",productId:"micros-group/confluence",shouldHighlightMention:e=>e.id===n};return g.mentionNameResolver=new s.j(new d,i),async function(e,t,n){let s=!1;if(n[a.pA]){const e=await(0,h.Z)();s=!0===(0,c.D)(e)}return new m.R("/gateway/api/v1/recommendations",e,t,s)}(g,y,p)}async function g(e,t,n,s,o,a){if(!e)throw new Error("MentionResource cannot be configured without a cloud id");const r=(null==n?void 0:n.spaceId)||void 0;return{mentionResource:await p(e,r,t,s,o,a),presenceResource:new i.ZP({url:"/gateway/api/directory/graphql",cloudId:e,productId:"confluence"}),mentionServiceUrl:`/gateway/api/mentions/${e}`,contextIdentifier:{containerId:r||"",objectId:(null==n?void 0:n.contentId)||"",childObjectId:(null==n?void 0:n.commentId)||""}}}},366185:(e,t,n)=>{n.d(t,{j:()=>a});var s=n(29298),i=n(978699),o=n(822814);class a{constructor(e,t={}){(0,s.Z)(this,"nameCache",new Map),(0,s.Z)(this,"nameQueue",new Map),(0,s.Z)(this,"nameStartTime",new Map),(0,s.Z)(this,"processingQueue",new Map),(0,s.Z)(this,"debounce",0),(0,s.Z)(this,"processQueue",(()=>{clearTimeout(this.debounce),this.debounce=0;const{queue:e,extraQueue:t}=this.splitQueueAtLimit();this.nameQueue=t,this.processingQueue=new Map([...this.processingQueue,...e]),this.client.lookupMentionNames(Array.from(e.keys())).then((t=>{t.forEach((t=>{const{id:n}=t;e.delete(n),this.resolveQueueItem(t)})),e.forEach(((e,t)=>{this.resolveQueueItem({id:t,status:i.dP.UNKNOWN})}))})).catch((()=>{e.forEach(((e,t)=>{this.resolveQueueItem({id:t,status:i.dP.SERVICE_ERROR})}))})),this.nameQueue.size>0&&this.scheduleProcessQueue()})),this.client=e,this.fireHydrationEvent=(0,o.Ng)(t)}lookupName(e){const t=this.nameCache.get(e);return t?(this.fireAnalytics(!0,t),t):new Promise((t=>{const n=this.processingQueue.get(e);n&&this.processingQueue.set(e,[...n,t]);const s=this.nameQueue.get(e)||[];this.nameQueue.set(e,[...s,t]),0!==s.length||n||this.nameStartTime.set(e,Date.now()),this.scheduleProcessQueue(),this.isQueueAtLimit()&&this.processQueue()}))}cacheName(e,t){this.nameCache.set(e,{id:e,name:t,status:i.dP.OK})}scheduleProcessQueue(){this.debounce||(this.debounce=window.setTimeout(this.processQueue,a.waitForBatch))}isQueueAtLimit(){return this.nameQueue.size>=this.client.getLookupLimit()}splitQueueAtLimit(){const e=Array.from(this.nameQueue.entries()),t=this.client.getLookupLimit();return{queue:new Map(e.slice(0,t)),extraQueue:new Map(e.slice(t))}}resolveQueueItem(e){const{id:t}=e,n=this.processingQueue.get(t);n&&(this.processingQueue.delete(t),this.nameCache.set(t,e),n.forEach((t=>{try{t(e)}catch(n){}})),this.fireAnalytics(!1,e))}fireAnalytics(e,t){const{id:n}=t,s=t.status===i.dP.OK?"completed":"failed",o=this.nameStartTime.get(n),a=o?Date.now()-o:0;this.nameStartTime.delete(n),this.fireHydrationEvent(s,n,e,a)}}(0,s.Z)(a,"waitForBatch",100)}}]);
//# sourceMappingURL=79551.4Gsn9bUwmk.js.map